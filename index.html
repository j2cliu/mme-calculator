<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MME Calculator - å°ç£ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 15px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            font-size: 24px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 13px;
            margin-top: -10px;
            margin-bottom: 20px;
        }
        
        .medication-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            position: relative;
        }
        
        .medication-row select,
        .medication-row input {
            width: 100%;
        }
        
        .dose-frequency-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        select, input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px; /* é¿å… iOS è‡ªå‹•ç¸®æ”¾ */
        }
        
        button {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 8px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 15px;
        }
        
        .remove-btn {
            background-color: #e74c3c;
            padding: 8px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .remove-btn:hover {
            background-color: #c0392b;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .warning {
            padding: 12px;
            margin-top: 15px;
            border-radius: 4px;
        }
        
        .warning.danger {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .warning.warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .warning.safe {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .hidden {
            display: none;
        }
        
        #loginBox input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            font-size: 16px;
        }
        
        #loginBox button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }
        
        .error {
            color: #e74c3c;
            margin-top: 10px;
        }
        
        /* å¹³æ¿ä»¥ä¸Š */
        @media (min-width: 768px) {
            body {
                padding: 50px 20px;
            }
            
            .container {
                padding: 30px;
            }
            
            h1 {
                font-size: 32px;
            }
            
            .medication-row {
                grid-template-columns: 2.5fr 2fr 1fr 1fr auto;
                padding: 10px;
                background-color: transparent;
            }
            
            .dose-frequency-group {
                display: contents; /* å–æ¶ˆæ‰‹æ©Ÿç‰ˆçš„åˆ†çµ„ */
            }
            
            .button-group {
                grid-template-columns: auto auto auto;
                gap: 10px;
            }
            
            button {
                width: auto;
                margin-bottom: 0;
            }
            
            .remove-btn {
                padding: 8px 15px;
                margin-top: 0;
            }
        }
        
        /* å¤§è¢å¹• */
        @media (min-width: 1024px) {
            .result {
                font-size: 18px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginBox" class="login-container">
        <div class="container">
            <h1>ğŸ”’ MME Calculator</h1>
            <p>è«‹è¼¸å…¥å­˜å–å¯†ç¢¼</p>
            <input type="password" id="password" placeholder="å¯†ç¢¼" onkeypress="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()">é€²å…¥</button>
            <p class="error" id="errorMsg"></p>
        </div>
    </div>

    <!-- ä¸»è¦è¨ˆç®—å™¨ -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <h1>ğŸ’Š MME Calculator</h1>
            <p class="subtitle">Morphine Milligram Equivalents (å°ç£ç‰ˆ)</p>
            
            <div id="medications">
                <div class="medication-row">
                    <select class="med-select" onchange="updateDoseOptions(this)">
                        <option value="">é¸æ“‡è—¥ç‰©</option>
                        <option value="codeine-oral">Codeine å£æœ (30mg/tab)</option>
                        <option value="codeine-injection">Codeine æ³¨å°„ (15mg/ml/amp)</option>
                        <option value="fentanyl-injection-100">Fentanyl æ³¨å°„ (100mcg/2ml/amp)</option>
                        <option value="fentanyl-injection-500">Fentanyl æ³¨å°„ (500mcg/10ml/amp)</option>
                        <option value="fentanyl-buccal-100">Fentanyl å£é ° (100mcg/film)</option>
                        <option value="fentanyl-buccal-200">Fentanyl å£é ° (200mcg/film)</option>
                        <option value="fentanyl-patch-12">Fentanyl è²¼ç‰‡ (12.5mcg/hr)</option>
                        <option value="fentanyl-patch-25">Fentanyl è²¼ç‰‡ (25mcg/hr)</option>
                        <option value="fentanyl-patch-50">Fentanyl è²¼ç‰‡ (50mcg/hr)</option>
                        <option value="meperidine-injection">Meperidine æ³¨å°„ (50mg/ml/amp)</option>
                        <option value="morphine-injection">Morphine æ³¨å°„ (10mg/ml/amp)</option>
                        <option value="morphine-oral-15">Morphine å£æœ (15mg/tab)</option>
                        <option value="morphine-oral-30">Morphine å£æœ (30mg/tab)</option>
                        <option value="nalbuphine-injection">Nalbuphine æ³¨å°„ (10mg/ml/amp)</option>
                        <option value="oxycodone-oral">Oxycodone å£æœ (10mg/tab)</option>
                        <option value="tramadol-oral">Tramadol å£æœ (100mg/tab)</option>
                        <option value="tramadol-injection">Tramadol æ³¨å°„ (100mg/2ml/amp)</option>
                        <option value="ultracet">Ultracet å£æœ (37.5mg/tab)</option>
                    </select>
                    <select class="dose-select" onchange="setCustomDose(this)">
                        <option value="">é¸æ“‡åŠ‘é‡</option>
                    </select>
                    <div class="dose-frequency-group">
                        <input type="number" class="dose" placeholder="æ•¸é‡" min="0" step="0.5">
                        <input type="number" class="frequency" placeholder="æ¬¡æ•¸/å¤©" min="0" step="0.5" value="1">
                    </div>
                    <button class="remove-btn hidden" onclick="removeRow(this)">ç§»é™¤</button>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="addMedication()">â• æ–°å¢è—¥ç‰©</button>
                <button onclick="calculate()" style="background-color: #27ae60;">è¨ˆç®— MME</button>
                <button onclick="reset()" style="background-color: #95a5a6;">æ¸…é™¤</button>
            </div>
            
            <div id="result"></div>
        </div>
    </div>

    <script>
        // å¯†ç¢¼è¨­å®š
        const ACCESS_PASSWORD = "edamme2024";

        function checkPassword() {
            const input = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');
            
            if (input === ACCESS_PASSWORD) {
                document.getElementById('loginBox').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                sessionStorage.setItem('authenticated', 'true');
            } else {
                errorMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦';
                document.getElementById('password').value = '';
            }
        }

        window.onload = function() {
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('loginBox').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
            }
        }

        const medications = {
            'codeine-oral': { dose: 30, unit: 'tab', factor: 0.15, route: 'å£æœ' },
            'codeine-injection': { dose: 15, unit: 'amp', factor: 0.15 * 2, route: 'æ³¨å°„' },
            
            'fentanyl-injection-100': { dose: 100, unit: 'amp', factor: 0.1, route: 'æ³¨å°„' },
            'fentanyl-injection-500': { dose: 500, unit: 'amp', factor: 0.1, route: 'æ³¨å°„' },
            'fentanyl-buccal-100': { dose: 100, unit: 'film', factor: 0.13, route: 'å£é °' },
            'fentanyl-buccal-200': { dose: 200, unit: 'film', factor: 0.13, route: 'å£é °' },
            'fentanyl-patch-12': { dose: 12.5, unit: 'patch', factor: 2.4, route: 'è²¼ç‰‡', isPatch: true },
            'fentanyl-patch-25': { dose: 25, unit: 'patch', factor: 2.4, route: 'è²¼ç‰‡', isPatch: true },
            'fentanyl-patch-50': { dose: 50, unit: 'patch', factor: 2.4, route: 'è²¼ç‰‡', isPatch: true },
            
            'meperidine-injection': { dose: 50, unit: 'amp', factor: 0.1, route: 'æ³¨å°„' },
            
            'morphine-injection': { dose: 10, unit: 'amp', factor: 3, route: 'æ³¨å°„' },
            'morphine-oral-15': { dose: 15, unit: 'tab', factor: 1, route: 'å£æœ' },
            'morphine-oral-30': { dose: 30, unit: 'tab', factor: 1, route: 'å£æœ' },
            
            'nalbuphine-injection': { dose: 10, unit: 'amp', factor: 1, route: 'æ³¨å°„' },
            
            'oxycodone-oral': { dose: 10, unit: 'tab', factor: 1.5, route: 'å£æœ' },
            
            'tramadol-oral': { dose: 100, unit: 'tab', factor: 0.1, route: 'å£æœ' },
            'tramadol-injection': { dose: 100, unit: 'amp', factor: 0.1, route: 'æ³¨å°„' },
            
            'ultracet': { dose: 37.5, unit: 'tab', factor: 0.1, route: 'å£æœ' }
        };

        const commonQuantities = {
            'tab': [0.5, 1, 1.5, 2, 3],
            'amp': [0.5, 1, 1.5, 2, 3],
            'patch': [1],
            'film': [1, 2]
        };

        function updateDoseOptions(selectElement) {
            const row = selectElement.closest('.medication-row');
            const doseSelect = row.querySelector('.dose-select');
            const doseInput = row.querySelector('.dose');
            const medKey = selectElement.value;

            doseSelect.innerHTML = '<option value="">é¸æ“‡åŠ‘é‡</option>';
            doseInput.value = '';

            if (medKey && medications[medKey]) {
                const med = medications[medKey];
                const quantities = commonQuantities[med.unit] || [1];
                
                quantities.forEach(qty => {
                    const option = document.createElement('option');
                    option.value = qty;
                    const totalDose = med.dose * qty;
                    option.text = `${qty} ${med.unit} (${totalDose}${med.unit === 'patch' ? 'mcg/hr' : med.unit === 'film' ? 'mcg' : 'mg'})`;
                    doseSelect.appendChild(option);
                });
            }
        }

        function setCustomDose(selectElement) {
            const row = selectElement.closest('.medication-row');
            const doseInput = row.querySelector('.dose');
            if (selectElement.value) {
                doseInput.value = selectElement.value;
            }
        }

        function addMedication() {
            const container = document.getElementById('medications');
            const newRow = container.firstElementChild.cloneNode(true);
            newRow.querySelector('.med-select').value = '';
            newRow.querySelector('.dose-select').innerHTML = '<option value="">é¸æ“‡åŠ‘é‡</option>';
            newRow.querySelector('.dose').value = '';
            newRow.querySelector('.frequency').value = '1';
            newRow.querySelector('.remove-btn').classList.remove('hidden');
            container.appendChild(newRow);
        }

        function removeRow(btn) {
            btn.closest('.medication-row').remove();
        }

        function calculate() {
            const rows = document.querySelectorAll('.medication-row');
            let totalMME = 0;
            let details = [];

            rows.forEach(row => {
                const medKey = row.querySelector('.med-select').value;
                const quantity = parseFloat(row.querySelector('.dose').value) || 0;
                const freq = parseFloat(row.querySelector('.frequency').value) || 1;

                if (medKey && quantity > 0) {
                    const med = medications[medKey];
                    const actualDose = med.dose * quantity;
                    let dailyMME;
                    
                    if (med.isPatch) {
                        dailyMME = actualDose * med.factor;
                    } else {
                        dailyMME = actualDose * freq * med.factor;
                    }
                    
                    totalMME += dailyMME;
                    
                    const medName = row.querySelector('.med-select').selectedOptions[0].text;
                    const freqText = med.isPatch ? '' : ` Ã— ${freq}/å¤©`;
                    details.push(`${medName}: ${quantity} ${med.unit}${freqText} = ${dailyMME.toFixed(1)} MME/day`);
                }
            });

            displayResult(totalMME, details);
        }

        function displayResult(totalMME, details) {
            const resultDiv = document.getElementById('result');
            
            if (totalMME === 0) {
                resultDiv.innerHTML = '<div class="result">è«‹è¼¸å…¥è—¥ç‰©å’ŒåŠ‘é‡</div>';
                return;
            }

            let warningClass = '';
            let warningText = '';

            if (totalMME >= 90) {
                warningClass = 'danger';
                warningText = 'âš ï¸ <strong>é«˜åŠ‘é‡è­¦ç¤ºï¼</strong><br>CDC å»ºè­°é¿å… â‰¥90 MME/day<br>è«‹è€ƒæ…®é™ä½åŠ‘é‡æˆ–è½‰ä»‹ç–¼ç—›å°ˆç§‘';
            } else if (totalMME >= 50) {
                warningClass = 'warning';
                warningText = 'âš ï¸ <strong>ä¸­ç­‰åŠ‘é‡</strong><br>æ¥è¿‘é«˜åŠ‘é‡ç¯„åœ (50-90 MME/day)<br>å»ºè­°è¬¹æ…è©•ä¼°é¢¨éšªæ•ˆç›Š';
            } else {
                warningClass = 'safe';
                warningText = 'âœ“ <strong>ç›¸å°å®‰å…¨ç¯„åœ</strong><br>(<50 MME/day)';
            }

            let html = '<div class="result">';
            html += `<strong>ç¸½ MMEï¼š${totalMME.toFixed(1)} mg/day</strong><br>`;
            html += '<small style="color: #7f8c8d;">(Morphine Milligram Equivalents per day)</small><br><br>';
            html += '<strong>è©³ç´°è¨ˆç®—ï¼š</strong><br>';
            details.forEach(d => html += `â€¢ ${d}<br>`);
            html += '</div>';

            html += `<div class="warning ${warningClass}">${warningText}</div>`;

            resultDiv.innerHTML = html;
        }

        function reset() {
            const container = document.getElementById('medications');
            const firstRow = container.firstElementChild;
            container.innerHTML = '';
            container.appendChild(firstRow);
            firstRow.querySelector('.med-select').value = '';
            firstRow.querySelector('.dose-select').innerHTML = '<option value="">é¸æ“‡åŠ‘é‡</option>';
            firstRow.querySelector('.dose').value = '';
            firstRow.querySelector('.frequency').value = '1';
            firstRow.querySelector('.remove-btn').classList.add('hidden');
            document.getElementById('result').innerHTML = '';
        }
    </script>
</body>
</html>
